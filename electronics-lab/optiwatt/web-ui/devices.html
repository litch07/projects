<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>All Devices - OptiWatt</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#10B981',
                        secondary: '#3B82F6',
                        accent: '#F59E0B'
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 dark:bg-gray-900 min-h-screen">

<!-- Global Header -->
<header class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-40">
    <div class="container mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-primary to-secondary rounded-lg flex items-center justify-center">
                    <span class="text-white font-bold text-xl">‚ö°</span>
                </div>
                <h1 class="text-2xl font-bold text-gray-800 dark:text-white">OptiWatt</h1>
            </div>
            <div class="flex items-center space-x-2 md:space-x-3">
                <button id="themeToggle" onclick="toggleTheme()" class="header-icon-btn" title="Toggle Theme">
                    <span class="icon-size">üåô</span>
                    <span class="header-icon-label" id="themeLabel">Dark Mode</span>
                </button>
                <button onclick="toggleNotificationsPanel()" class="header-icon-btn relative" title="Notifications">
                    <span class="icon-size">üîî</span>
                    <span class="header-icon-label">Notifications</span>
                </button>
                <button onclick="openSettingsModal()" class="header-icon-btn" title="Settings">
                    <span class="icon-size">‚öôÔ∏è</span>
                    <span class="header-icon-label">Settings</span>
                </button>
                <button id="profileMenuBtn" onclick="toggleProfileMenu()" class="header-icon-btn" title="Profile" aria-expanded="false">
                    <span class="icon-size">üë§</span>
                    <span class="header-icon-label">Profile</span>
                </button>
                <div id="profileMenu" class="hidden absolute top-20 right-4 bg-white dark:bg-gray-800 rounded-xl shadow-xl p-4 border border-gray-200 dark:border-gray-700 z-50">
                    <div class="flex items-center space-x-3 mb-4 pb-4 border-b border-gray-200 dark:border-gray-700">
                        <div class="w-12 h-12 bg-gradient-to-br from-primary to-secondary rounded-full flex items-center justify-center text-white font-bold text-xl">A</div>
                        <div>
                            <p id="profileName" class="font-bold text-gray-800 dark:text-white">Admin</p>
                            <p id="profileEmail" class="text-sm text-gray-600 dark:text-gray-400">admin@example.com</p>
                        </div>
                    </div>
                    <button onclick="confirmLogout()" class="w-full text-left px-4 py-2 rounded-lg hover:bg-red-50 dark:hover:bg-red-900/20 text-red-600 dark:text-red-400 font-semibold transition">üö™ Logout</button>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- Notifications Panel -->
<div id="notificationsPanel" class="hidden fixed top-20 right-4 z-50 w-80 bg-white dark:bg-gray-800 rounded-xl shadow-2xl border border-gray-200 dark:border-gray-700 p-4">
    <h3 class="text-lg font-bold text-gray-800 dark:text-white mb-3">üì¨ Notifications</h3>
    <div class="space-y-2 max-h-96 overflow-y-auto">
        <p class="text-gray-600 dark:text-gray-400 text-sm">No new notifications</p>
    </div>
</div>

<!-- Main Content -->
<main class="container mx-auto px-4 py-8">
    <button onclick="window.location.href='index.html'" class="page-back-btn mb-6">‚Üê Dashboard</button>

    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-3xl font-bold text-gray-800 dark:text-white">üí° All Active Devices</h2>
            <p class="text-gray-600 dark:text-gray-400 mt-2">Monitor and control all appliances across rooms</p>
        </div>
        <div class="flex items-center space-x-4">
            <div class="relative">
                <input type="text" id="searchDevices" placeholder="Search devices..." oninput="filterDevices()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white pl-10">
                <span class="absolute left-3 top-2.5 text-gray-400">üîç</span>
            </div>
            <select id="sortDevices" onchange="sortDevices()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white">
                <option value="name">Sort by Name</option>
                <option value="room">Sort by Room</option>
                <option value="power">Sort by Power</option>
                <option value="status">Sort by Status</option>
            </select>
        </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold">Total Devices</p>
                    <p id="totalDevices" class="text-3xl font-bold text-primary mt-2">0</p>
                </div>
                <div class="text-4xl">üí°</div>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold">Active Now</p>
                    <p id="activeDevices" class="text-3xl font-bold text-green-600 mt-2">0</p>
                </div>
                <div class="text-4xl">‚úÖ</div>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold">Total Power</p>
                    <p id="totalPower" class="text-3xl font-bold text-accent mt-2">0 W</p>
                </div>
                <div class="text-4xl">‚ö°</div>
            </div>
        </div>
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-600 dark:text-gray-400 text-sm font-semibold">Rooms</p>
                    <p id="totalRooms" class="text-3xl font-bold text-secondary mt-2">0</p>
                </div>
                <div class="text-4xl">üè†</div>
            </div>
        </div>
    </div>

    <div id="devicesGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
</main>

<!-- Settings Modal -->
<div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="settings-modal-container">
        <!-- Sidebar -->
        <div class="w-64 bg-gray-50 dark:bg-gray-900 p-6 overflow-y-auto">
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-6">‚öôÔ∏è Settings</h2>
            <div class="space-y-2">
                <button onclick="switchSettingsTab('password')" class="settings-tab-btn active" data-tab="password">
                    <span class="mr-3 text-xl">üîí</span> Password
                </button>
                <button onclick="switchSettingsTab('automation')" class="settings-tab-btn" data-tab="automation">
                    <span class="mr-3 text-xl">ü§ñ</span> Automation
                </button>
                <button onclick="switchSettingsTab('energyCost')" class="settings-tab-btn" data-tab="energyCost">
                    <span class="mr-3 text-xl">üí∞</span> Energy Cost
                </button>
                <button onclick="switchSettingsTab('notifications')" class="settings-tab-btn" data-tab="notifications">
                    <span class="mr-3 text-xl">üîî</span> Notifications
                </button>
                <button onclick="switchSettingsTab('exportLogs')" class="settings-tab-btn" data-tab="exportLogs">
                    <span class="mr-3 text-xl">üìä</span> Export Logs
                </button>
                <button onclick="switchSettingsTab('reset')" class="settings-tab-btn" data-tab="reset">
                    <span class="mr-3 text-xl">üîÑ</span> Reset
                </button>
            </div>
        </div>

        <!-- Content Area -->
        <div class="flex-1 bg-white dark:bg-gray-800 p-8 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 id="settingsTitle" class="text-2xl font-bold text-gray-800 dark:text-white">Password</h3>
                <button onclick="closeSettingsModal()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-3xl">&times;</button>
            </div>

            <!-- Password Tab -->
            <div id="passwordTab" class="settings-content">
                <form id="passwordForm" onsubmit="changePassword(event)" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Current Password</label>
                        <input type="password" id="currentPassword" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">New Password</label>
                        <input type="password" id="newPassword" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white" required minlength="6">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">Confirm New Password</label>
                        <input type="password" id="confirmPassword" class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white" required minlength="6">
                    </div>
                    <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-3 rounded-lg transition">
                        Change Password
                    </button>
                </form>
            </div>

            <!-- Automation Tab (FIXED Layout) -->
    <div id="automationTab" class="settings-content hidden">
        <div class="space-y-4">
            <!-- Global Automation (FIXED - consistent with other items) -->
            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                <div>
                    <h4 class="font-bold text-gray-800 dark:text-white">Global Automation</h4>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Enable smart automation features</p>
                </div>
                <div id="globalAutomationToggle" class="toggle-switch" onclick="toggleGlobalAutomation()"></div>
            </div>

            <!-- Vacancy Sleep -->
            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <h4 class="font-bold text-gray-800 dark:text-white">Vacancy Sleep</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Auto-sleep devices in vacant rooms</p>
                    </div>
                    <div id="vacancySleepToggle" class="toggle-switch" onclick="toggleVacancySleep()"></div>
                </div>
                <div id="vacancyTimer" class="mt-4 hidden">
                    <label class="text-sm text-gray-600 dark:text-gray-400">Delay: <span id="vacancyTimerValue">10</span> minutes</label>
                    <input type="range" min="5" max="60" step="5" value="10" oninput="updateVacancyTimer(this.value)" class="w-full mt-2">
                </div>
            </div>

            <!-- Scheduled Sleep -->
            <div class="p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                <div class="flex items-center justify-between mb-2">
                    <div>
                        <h4 class="font-bold text-gray-800 dark:text-white">Scheduled Sleep</h4>
                        <p class="text-sm text-gray-600 dark:text-gray-400">Auto-sleep during specific hours</p>
                    </div>
                    <div id="scheduledSleepToggle" class="toggle-switch" onclick="toggleScheduledSleep()"></div>
                </div>
                <div id="scheduledSleepConfig" class="mt-4 hidden space-y-3">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-sm text-gray-600 dark:text-gray-400">Start Time</label>
                            <input type="time" id="sleepStartTime" value="22:00" onchange="updateSleepSchedule()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white mt-1">
                        </div>
                        <div>
                            <label class="text-sm text-gray-600 dark:text-gray-400">End Time</label>
                            <input type="time" id="sleepEndTime" value="06:00" onchange="updateSleepSchedule()" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-800 dark:text-white mt-1">
                        </div>
                    </div>
                    <button onclick="toggleExemptionsSection()" class="text-primary hover:text-primary/80 text-sm font-semibold">
                        Manage Device Exemptions
                    </button>
                    <div id="sleepExemptions" class="hidden mt-4 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg">
                        <h5 class="font-semibold text-gray-800 dark:text-white mb-3">Exempt Devices</h5>
                        <div id="sleepExemptDevicesList" class="space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>


                <!-- Energy Cost Tab -->
                <div id="energyCostTab" class="settings-content hidden">
                    <div class="p-6 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-bold text-gray-800 dark:text-white">Current Rate</h4>
                            <span class="text-3xl font-bold text-primary">$0.15 <span class="text-base text-gray-600 dark:text-gray-400">/ kWh</span></span>
                        </div>
                        <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mt-4">
                            <p class="text-sm text-yellow-800 dark:text-yellow-200">
                                <strong>Note:</strong> Energy costs are currently fixed. To update pricing, please contact the help desk.
                            </p>
                            <p class="text-sm text-yellow-700 dark:text-yellow-300 mt-2">
                                üìû Help Desk: <strong>support@optiwatt.com</strong>
                            </p>
                        </div>
                    </div>
                </div>

            <!-- Notifications Tab -->
            <div id="notificationsTab" class="settings-content hidden">
                <div class="space-y-4">
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-white">House Goal Exceeded</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Alert when total usage exceeds limit</p>
                        </div>
                        <input type="checkbox" id="notifHouseGoal" onchange="toggleNotificationPref('houseGoalExceeded')" class="w-5 h-5">
                    </div>
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-white">Room Goal Exceeded</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Alert when room exceeds its goal</p>
                        </div>
                        <input type="checkbox" id="notifRoomGoal" onchange="toggleNotificationPref('roomGoalExceeded')" class="w-5 h-5">
                    </div>
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-white">Daily Goal Exceeded</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Alert for daily usage limit</p>
                        </div>
                        <input type="checkbox" id="notifDailyGoal" onchange="toggleNotificationPref('dailyGoalExceeded')" class="w-5 h-5">
                    </div>
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-white">Monthly Goal Exceeded</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Alert for monthly usage limit</p>
                        </div>
                        <input type="checkbox" id="notifMonthlyGoal" onchange="toggleNotificationPref('monthlyGoalExceeded')" class="w-5 h-5">
                    </div>
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-white">Room Vacancy</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Notify when room becomes vacant</p>
                        </div>
                        <input type="checkbox" id="notifVacancy" onchange="toggleNotificationPref('roomVacancy')" class="w-5 h-5">
                    </div>
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-white">Device Toggled</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Notify on device state changes</p>
                        </div>
                        <input type="checkbox" id="notifDevice" onchange="toggleNotificationPref('deviceToggled')" class="w-5 h-5">
                    </div>
                    <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-900 rounded-lg">
                        <div>
                            <h4 class="font-semibold text-gray-800 dark:text-white">System Notices</h4>
                            <p class="text-sm text-gray-600 dark:text-gray-400">General system notifications</p>
                        </div>
                        <input type="checkbox" id="notifSystem" onchange="toggleNotificationPref('systemNotices')" class="w-5 h-5">
                    </div>
                </div>
            </div>

            <!-- Export Logs Tab -->
            <div id="exportLogsTab" class="settings-content hidden">
                <div class="space-y-4">
                    <button onclick="exportToCSV()" class="w-full bg-primary hover:bg-primary/90 text-white font-bold py-4 rounded-lg transition flex items-center justify-center">
                        <span class="text-2xl mr-3">üì•</span>
                        Export Data to CSV
                    </button>
                    <button onclick="printReport()" class="w-full bg-secondary hover:bg-secondary/90 text-white font-bold py-4 rounded-lg transition flex items-center justify-center">
                        <span class="text-2xl mr-3">üñ®Ô∏è</span>
                        Print Report
                    </button>
                </div>
            </div>

            <!-- Reset Tab -->
            <div id="resetTab" class="settings-content hidden">
                <div class="bg-red-50 dark:bg-red-900/20 border-2 border-red-200 dark:border-red-800 rounded-lg p-6">
                    <h4 class="text-xl font-bold text-red-600 dark:text-red-400 mb-3">‚ö†Ô∏è Warning</h4>
                    <p class="text-gray-700 dark:text-gray-300 mb-4">
                        This will permanently delete all your rooms, devices, and usage statistics. This action cannot be undone.
                    </p>
                    <button onclick="confirmResetStatistics()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-4 rounded-lg transition">
                        Reset All Data
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// DEVICES PAGE - COMPLETE WITH ALL SETTINGS
// ==========================================

let allDevices = [];
let filteredDevices = [];
const ADMIN_PASSWORD = 'admin';

document.addEventListener('DOMContentLoaded', () => {
    initializeTheme();
    loadAllDevices();
    renderDevices();
    updateStats();
});

function initializeTheme() {
    const savedTheme = localStorage.getItem('theme') || 'light';
    if (savedTheme === 'dark') {
        document.documentElement.classList.add('dark');
        updateThemeUI(true);
    } else {
        document.documentElement.classList.remove('dark');
        updateThemeUI(false);
    }
}

function updateThemeUI(isDark) {
    const themeToggle = document.getElementById('themeToggle');
    const themeLabel = document.getElementById('themeLabel');
    if (themeToggle && themeLabel) {
        themeToggle.querySelector('.icon-size').textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        themeLabel.textContent = isDark ? 'Light Mode' : 'Dark Mode';
    }
}

function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.classList.contains('dark');
    
    if (isDark) {
        html.classList.remove('dark');
        localStorage.setItem('theme', 'light');
        updateThemeUI(false);
    } else {
        html.classList.add('dark');
        localStorage.setItem('theme', 'dark');
        updateThemeUI(true);
    }
}

function loadAllDevices() {
    const rooms = JSON.parse(localStorage.getItem('optiwatt_rooms') || '[]');
    allDevices = [];
    
    rooms.forEach(room => {
        if (room.appliances && room.appliances.length > 0) {
            room.appliances.forEach(appliance => {
                allDevices.push({
                    ...appliance,
                    roomId: room.id,
                    roomName: room.name
                });
            });
        }
    });
    
    filteredDevices = [...allDevices];
}

function renderDevices() {
    const grid = document.getElementById('devicesGrid');
    
    if (filteredDevices.length === 0) {
        grid.innerHTML = `
            <div class="col-span-full text-center py-16">
                <div class="text-6xl mb-4">üí°</div>
                <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-2">No devices found</h3>
                <p class="text-gray-600 dark:text-gray-400">Add rooms and appliances to get started</p>
            </div>
        `;
        return;
    }
    
    grid.innerHTML = filteredDevices.map(device => {
        const statusColor = device.status 
            ? 'bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200' 
            : 'bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200';
        const statusText = device.status ? 'ON' : 'OFF';
        
        return `
            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-md p-6 hover:shadow-lg transition">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-bold text-gray-800 dark:text-white">${device.name}</h3>
                    <button onclick="toggleDeviceFromList('${device.roomId}', '${device.id}')" class="px-4 py-2 rounded-lg font-semibold transition ${statusColor}">
                        ${statusText}
                    </button>
                </div>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Room:</span>
                        <span class="font-semibold text-gray-800 dark:text-white">${device.roomName}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Power:</span>
                        <span class="font-semibold text-primary">${device.currentPower || 0} W</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">Relay:</span>
                        <span class="font-semibold text-gray-800 dark:text-white">CH${device.relayChannel}</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600 dark:text-gray-400">PZEM:</span>
                        <span class="font-semibold text-gray-800 dark:text-white">${device.pzemAddress}</span>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function updateStats() {
    const rooms = JSON.parse(localStorage.getItem('optiwatt_rooms') || '[]');
    const totalDevicesCount = allDevices.length;
    const activeCount = allDevices.filter(d => d.status).length;
    const totalPowerValue = allDevices.filter(d => d.status).reduce((sum, d) => sum + (d.currentPower || 0), 0);
    
    document.getElementById('totalDevices').textContent = totalDevicesCount;
    document.getElementById('activeDevices').textContent = activeCount;
    document.getElementById('totalPower').textContent = totalPowerValue + ' W';
    document.getElementById('totalRooms').textContent = rooms.length;
}

function toggleDeviceFromList(roomId, deviceId) {
    const rooms = JSON.parse(localStorage.getItem('optiwatt_rooms') || '[]');
    const room = rooms.find(r => r.id === roomId);
    if (!room) return;
    
    const device = room.appliances.find(a => a.id === deviceId);
    if (!device) return;
    
    device.status = !device.status;
    
    if (device.status) {
        device.currentPower = Math.floor(Math.random() * 300) + 50;
        device.onSince = Date.now();
    } else {
        if (device.onSince) {
            const runtime = Date.now() - device.onSince;
            device.dailyRuntime = (device.dailyRuntime || 0) + runtime;
            device.monthlyRuntime = (device.monthlyRuntime || 0) + runtime;
        }
        device.currentPower = 0;
        device.onSince = null;
    }
    
    localStorage.setItem('optiwatt_rooms', JSON.stringify(rooms));
    loadAllDevices();
    renderDevices();
    updateStats();
    showSuccessMessage(`${device.name} turned ${device.status ? 'ON' : 'OFF'}`);
}

function filterDevices() {
    const searchTerm = document.getElementById('searchDevices').value.toLowerCase();
    
    if (searchTerm === '') {
        filteredDevices = [...allDevices];
    } else {
        filteredDevices = allDevices.filter(device => 
            device.name.toLowerCase().includes(searchTerm) ||
            device.roomName.toLowerCase().includes(searchTerm)
        );
    }
    renderDevices();
}

function sortDevices() {
    const sortBy = document.getElementById('sortDevices').value;
    const sorted = [...filteredDevices];
    
    switch(sortBy) {
        case 'name':
            sorted.sort((a, b) => a.name.localeCompare(b.name));
            break;
        case 'room':
            sorted.sort((a, b) => a.roomName.localeCompare(b.roomName));
            break;
        case 'power':
            sorted.sort((a, b) => (b.currentPower || 0) - (a.currentPower || 0));
            break;
        case 'status':
            sorted.sort((a, b) => (b.status ? 1 : 0) - (a.status ? 1 : 0));
            break;
    }
    
    filteredDevices = sorted;
    renderDevices();
}

// ==========================================
// SETTINGS FUNCTIONS - ALL TABS WORKING
// ==========================================

function openSettingsModal() {
    const modal = document.getElementById('settingsModal');
    if (modal) {
        modal.classList.remove('hidden');
        updateGlobalAutomationToggle();
        updateVacancySleepToggle();
        updateScheduledSleepToggle();
        updateNotificationUI();
    }
}

function closeSettingsModal() {
    const modal = document.getElementById('settingsModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function switchSettingsTab(tabName) {
    document.querySelectorAll('.settings-tab-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.tab === tabName) {
            btn.classList.add('active');
        }
    });
    
    document.querySelectorAll('.settings-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    const activeContent = document.getElementById(tabName + 'Tab');
    if (activeContent) {
        activeContent.classList.remove('hidden');
    }
    
    const titles = {
        password: 'Password',
        automation: 'Automation',
        energyCost: 'Energy Cost',
        notifications: 'Notifications',
        exportLogs: 'Export Logs',
        reset: 'Reset'
    };
    
    const titleEl = document.getElementById('settingsTitle');
    if (titleEl) {
        titleEl.textContent = titles[tabName] || 'Settings';
    }
}

function changePassword(event) {
    event.preventDefault();
    const currentPass = document.getElementById('currentPassword').value;
    const newPass = document.getElementById('newPassword').value;
    const confirmPass = document.getElementById('confirmPassword').value;
    
    if (currentPass !== ADMIN_PASSWORD) {
        showErrorMessage('Current password is incorrect');
        return;
    }
    
    if (newPass !== confirmPass) {
        showErrorMessage('Passwords do not match');
        return;
    }
    
    if (newPass.length < 6) {
        showErrorMessage('Password must be at least 6 characters');
        return;
    }
    
    showSuccessMessage('Password changed successfully');
    event.target.reset();
}

function toggleGlobalAutomation() {
    const automation = localStorage.getItem('optiwatt_automation') === 'true';
    localStorage.setItem('optiwatt_automation', !automation);
    updateGlobalAutomationToggle();
    showSuccessMessage(automation ? 'Global Automation disabled' : 'Global Automation enabled');
}

function updateGlobalAutomationToggle() {
    const toggle = document.getElementById('globalAutomationToggle');
    const automation = localStorage.getItem('optiwatt_automation') === 'true';
    if (toggle) {
        if (automation) {
            toggle.classList.add('active');
        } else {
            toggle.classList.remove('active');
        }
    }
}

function toggleVacancySleep() {
    const settings = JSON.parse(localStorage.getItem('optiwatt_settings') || '{}');
    settings.vacancySleepEnabled = !settings.vacancySleepEnabled;
    localStorage.setItem('optiwatt_settings', JSON.stringify(settings));
    updateVacancySleepToggle();
    
    const timerSection = document.getElementById('vacancyTimer');
    if (timerSection) {
        if (settings.vacancySleepEnabled) {
            timerSection.classList.remove('hidden');
        } else {
            timerSection.classList.add('hidden');
        }
    }
    showSuccessMessage(settings.vacancySleepEnabled ? 'Vacancy Sleep enabled' : 'Vacancy Sleep disabled');
}

function updateVacancySleepToggle() {
    const toggle = document.getElementById('vacancySleepToggle');
    const settings = JSON.parse(localStorage.getItem('optiwatt_settings') || '{}');
    if (toggle) {
        if (settings.vacancySleepEnabled) {
            toggle.classList.add('active');
        } else {
            toggle.classList.remove('active');
        }
    }
}

function updateVacancyTimer(value) {
    const settings = JSON.parse(localStorage.getItem('optiwatt_settings') || '{}');
    settings.vacancyDelayMinutes = parseInt(value);
    localStorage.setItem('optiwatt_settings', JSON.stringify(settings));
    const display = document.getElementById('vacancyTimerValue');
    if (display) display.textContent = value;
}

function toggleScheduledSleep() {
    const settings = JSON.parse(localStorage.getItem('optiwatt_settings') || '{}');
    settings.scheduledSleepEnabled = !settings.scheduledSleepEnabled;
    localStorage.setItem('optiwatt_settings', JSON.stringify(settings));
    updateScheduledSleepToggle();
    
    const configSection = document.getElementById('scheduledSleepConfig');
    if (configSection) {
        if (settings.scheduledSleepEnabled) {
            configSection.classList.remove('hidden');
        } else {
            configSection.classList.add('hidden');
        }
    }
    showSuccessMessage(settings.scheduledSleepEnabled ? 'Scheduled Sleep enabled' : 'Scheduled Sleep disabled');
}

function updateScheduledSleepToggle() {
    const toggle = document.getElementById('scheduledSleepToggle');
    const settings = JSON.parse(localStorage.getItem('optiwatt_settings') || '{}');
    if (toggle) {
        if (settings.scheduledSleepEnabled) {
            toggle.classList.add('active');
        } else {
            toggle.classList.remove('active');
        }
    }
}

function updateSleepSchedule() {
    const settings = JSON.parse(localStorage.getItem('optiwatt_settings') || '{}');
    const startInput = document.getElementById('sleepStartTime');
    const endInput = document.getElementById('sleepEndTime');
    if (startInput) settings.sleepStartTime = startInput.value;
    if (endInput) settings.sleepEndTime = endInput.value;
    localStorage.setItem('optiwatt_settings', JSON.stringify(settings));
    showSuccessMessage('Sleep schedule updated');
}

function toggleNotificationPref(prefKey) {
    const prefs = JSON.parse(localStorage.getItem('optiwatt_notification_prefs') || '{}');
    prefs[prefKey] = !prefs[prefKey];
    localStorage.setItem('optiwatt_notification_prefs', JSON.stringify(prefs));
    showSuccessMessage('Notification preferences updated');
}

function updateNotificationUI() {
    const prefs = JSON.parse(localStorage.getItem('optiwatt_notification_prefs') || '{}');
    const checks = {
        notifHouseGoal: 'houseGoalExceeded',
        notifRoomGoal: 'roomGoalExceeded',
        notifDailyGoal: 'dailyGoalExceeded',
        notifMonthlyGoal: 'monthlyGoalExceeded',
        notifVacancy: 'roomVacancy',
        notifDevice: 'deviceToggled',
        notifSystem: 'systemNotices'
    };
    
    Object.entries(checks).forEach(([id, key]) => {
        const el = document.getElementById(id);
        if (el) el.checked = prefs[key] !== false;
    });
}

function exportAllToCSV() {
    const rooms = JSON.parse(localStorage.getItem('optiwatt_rooms') || '[]');
    const csvContent = [
        ['OptiWatt System Export'],
        ['Generated:', new Date().toLocaleString()],
        [''],
        ['Total Rooms', rooms.length],
        ['Total Appliances', rooms.reduce((sum, r) => sum + (r.appliances?.length || 0), 0)]
    ];
    
    const csv = csvContent.map(row => row.join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'optiwatt-export-' + Date.now() + '.csv';
    a.click();
    URL.revokeObjectURL(url);
    showSuccessMessage('Data exported successfully');
}

function printAllReport() {
    const rooms = JSON.parse(localStorage.getItem('optiwatt_rooms') || '[]');
    const printWindow = window.open('', '', 'width=800,height=600');
    printWindow.document.write(`
        <html>
        <head>
            <title>OptiWatt Report</title>
            <style>
                body { font-family: Arial, sans-serif; padding: 40px; }
                h1 { color: #10B981; }
                table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
                th { background-color: #10B981; color: white; }
            </style>
        </head>
        <body>
            <h1>OptiWatt System Report</h1>
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            <table>
                <tr><th>Metric</th><th>Value</th></tr>
                <tr><td>Total Rooms</td><td>${rooms.length}</td></tr>
                <tr><td>Total Appliances</td><td>${rooms.reduce((sum, r) => sum + (r.appliances?.length || 0), 0)}</td></tr>
            </table>
        </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function confirmResetAllStatistics() {
    if (confirm('‚ö†Ô∏è WARNING: This will permanently delete all rooms, devices, and usage statistics. This action cannot be undone. Are you sure?')) {
        localStorage.removeItem('optiwatt_rooms');
        localStorage.removeItem('optiwatt_settings');
        localStorage.removeItem('optiwatt_automation');
        showSuccessMessage('All data has been reset');
        setTimeout(() => {
            window.location.reload();
        }, 1500);
    }
}

// ==========================================
// HEADER FUNCTIONS
// ==========================================

function toggleNotificationsPanel() {
    const panel = document.getElementById('notificationsPanel');
    if (panel) {
        panel.classList.toggle('hidden');
    }
}

function toggleProfileMenu() {
    const menu = document.getElementById('profileMenu');
    if (menu) {
        menu.classList.toggle('hidden');
    }
}

function confirmLogout() {
    if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('optiwatt_session');
        window.location.href = 'login.html';
    }
}

// ==========================================
// UTILITY FUNCTIONS
// ==========================================

function showSuccessMessage(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-24 right-4 z-50 px-6 py-4 rounded-lg shadow-2xl fade-in bg-primary text-white font-semibold';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.style.transition = 'opacity 0.5s';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 500);
    }, 3000);
}

function showErrorMessage(message) {
    const toast = document.createElement('div');
    toast.className = 'fixed top-24 right-4 z-50 px-6 py-4 rounded-lg shadow-2xl fade-in bg-red-600 text-white font-semibold';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => {
        toast.style.transition = 'opacity 0.5s';
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 500);
    }, 3000);
}
</script>
</body>
</html>
